# フェーズ6 タスク一覧（ダッシュボード可視化 /）

対象: `docs/Plan.md` の「フェーズ6: ダッシュボード可視化（/）」

## Task 1: ダッシュボード画面の骨格とレイアウトの実装
- 目的: / に可視化コンポーネントを配置するためのUI骨格を整える。
- 作業内容:
  - `/` ルートにダッシュボード画面を実装する。
  - サマリカード領域・表示範囲切替・資産推移グラフ領域・キャッシュフロー表領域の配置を決める。
  - サマリカード領域は `position: sticky; top: 0;` とし、半透明バックドロップで可読性を確保する。
- 自動テスト: 不要（UI骨格の表示はTask 3〜6のE2Eで担保するため）。
- 受入基準（Gherkin）:
  - シナリオ: ダッシュボードの主要領域が表示される
    - 前提: ログイン済みユーザーである
    - もし: `/` を開く
    - ならば: サマリカード領域が表示される
    - かつ: 資産推移グラフ領域とキャッシュフロー表領域が表示される
    - かつ: スクロールしてもサマリカード領域が固定表示される

## Task 2: ダッシュボード用のデータ取得とシミュレーション実行フロー
- 目的: 入力データを集約し、フェーズ4のシミュレーション結果を画面に供給できるようにする。
- 作業内容:
  - `profiles`/`simulation_settings`/各入力テーブルのデータを Query で取得する。
  - 取得データを `shared/domain/simulation` に渡して月次結果を生成する。
  - UI からは直接 `supabaseClient` を呼ばず、スライスの Query を経由する。
- 自動テスト: 要（統合テスト: Query Handler で取得した入力を用い、シミュレーション結果が生成されることを `tests/integration` で確認する）。
- 受入基準（Gherkin）:
  - シナリオ: シミュレーション結果がダッシュボードに渡される
    - 前提: 入力データが保存済みである
    - もし: `/` を開く
    - ならば: シミュレーション結果が生成される
    - かつ: 結果がサマリ・グラフ・表の描画に利用される
  - シナリオ: UI が直接 Supabase に依存していない
    - 前提: `docs/Guideline.md` に UI からの直接更新/参照禁止が定義されている
    - もし: ダッシュボードのデータ取得処理を確認する
    - ならば: Query Handler を経由してデータ取得している
    - かつ: UI コンポーネント内で `supabaseClient` を直接使用していない

## Task 3: 表示範囲切替（直近5年 / 全期間）の状態管理
- 目的: 表示範囲切替がグラフと表に一貫して反映される状態管理を用意する。
- 作業内容:
  - 直近5年/全期間のトグルUIを実装する。
  - 選択状態に応じて月次配列をフィルタリングする共通ロジックを作成する。
  - グラフと表は同一のフィルタ済みデータを参照する。
- 自動テスト: 要（E2E: 表示範囲切替でグラフ/表の期間が同時に更新されることを確認する）。
- 受入基準（Gherkin）:
  - シナリオ: 表示範囲切替がグラフと表に反映される
    - 前提: シミュレーション結果が表示されている
    - もし: 表示範囲を「直近5年」に切り替える
    - ならば: グラフと表が直近5年のデータに切り替わる
    - もし: 表示範囲を「全期間」に切り替える
    - ならば: グラフと表が全期間のデータに切り替わる

## Task 4: サマリカード（累計収支・平均月残高・資産寿命）の算出と表示
- 目的: ダッシュボードの要約指標を直感的に確認できるようにする。
- 作業内容:
  - 累計収支（範囲内の月次収支合計）を算出する。
  - 平均月残高（範囲内の total_balance の平均）を算出する。
  - 資産寿命（枯渇月）を表示し、枯渇月が存在する場合は年月を明示する。
- 自動テスト: 要（ユニット: 指標算出ロジック、E2E: 表示範囲切替に追従して表示値が更新されることを確認する）。
- 受入基準（Gherkin）:
  - シナリオ: サマリカードに主要指標が表示される
    - 前提: シミュレーション結果が存在する
    - もし: `/` を開く
    - ならば: 累計収支と平均月残高が表示される
    - かつ: 資産寿命（枯渇月）が表示される
  - シナリオ: サマリ指標が表示範囲に追従する
    - 前提: 表示範囲の切替が可能である
    - もし: 表示範囲を「直近5年」に切り替える
    - ならば: 累計収支と平均月残高が直近5年の値に更新される

## Task 5: 資産推移グラフ（cash + investment のスタック表示）
- 目的: 資産推移を直感的に把握できるグラフを提供する。
- 作業内容:
  - cash と investment をスタック表示するライン/エリアチャートを実装する。
  - 枯渇月がある場合はグラフ上でハイライトする。
  - 表示範囲切替に追従してデータを描画する。
- 自動テスト: 要（E2E: 枯渇月のハイライト表示と範囲切替反映を確認する）。
- 受入基準（Gherkin）:
  - シナリオ: 資産推移がスタック表示される
    - 前提: cash と investment の月次データがある
    - もし: グラフを表示する
    - ならば: cash と investment がスタックされた状態で描画される
  - シナリオ: 枯渇月がハイライトされる
    - 前提: 資産がマイナスになるシナリオがある
    - もし: グラフを表示する
    - ならば: 枯渇月が視覚的に区別される

## Task 6: 月次キャッシュフロー表（仮想スクロール）
- 目的: 長期間データでも快適に閲覧できる表を提供する。
- 作業内容:
  - 月次収入・支出・差分・残高を表示するテーブルを実装する。
  - 長い月次データに対して仮想スクロールを導入する。
  - 表示範囲切替に追従して行数が変わるようにする。
- 自動テスト: 要（E2E: 仮想スクロールで行が描画され、範囲切替で行数が変わることを確認する）。
- 受入基準（Gherkin）:
  - シナリオ: キャッシュフロー表が仮想スクロールで表示される
    - 前提: 長期間の月次データが存在する
    - もし: 表をスクロールする
    - ならば: 表示範囲に応じた行のみがレンダリングされる
  - シナリオ: 表示範囲切替が表に反映される
    - 前提: 表示範囲の切替が可能である
    - もし: 表示範囲を切り替える
    - ならば: 表の行数と内容が切り替わる

## Task 7: ダッシュボードのパフォーマンス確認と最適化
- 目的: 1,000件規模の月次データでも滑らかな描画を維持する。
- 作業内容:
  - グラフ描画とテーブルの再レンダリング頻度を確認し、必要に応じて memo 化や分割描画を行う。
  - 1,000件規模の月次データでスクロールや切替がストレスなく動くことを確認する。
- 自動テスト: 不要（パフォーマンスは手動計測・体感確認を主とし、数値基準はDODで担保する）。
- 受入基準（Gherkin）:
  - シナリオ: 1,000件規模でもフレーム落ちが顕著でない
    - 前提: 1,000件規模の月次データが表示されている
    - もし: グラフと表をスクロールし、範囲切替を行う
    - ならば: 体感でフレーム落ちが顕著でない
