# フェーズ8 タスク一覧（運用・品質保証）

対象: `docs/Plan.md` の「フェーズ8: 運用・品質保証」

## Task 1: CI ワークフローの拡張（lint/typecheck/unit/integration/E2E/build）
- 目的: リリース可能な品質ゲートを CI で担保する。
- 作業内容:
  - GitHub Actions で `pnpm lint` / `pnpm typecheck` / `pnpm test:unit` / `pnpm test:integration` / `pnpm test:e2e` / `pnpm build` を実行するワークフローを構成する。
  - `pnpm` キャッシュを有効化し、ジョブを lint・test・build の単位で分割する。
  - PR と `main` の両方で CI が動作することを確認し、ブランチ保護で必須チェックに設定する。
- 自動テスト: 要（GitHub Actions）
- 受入基準（Gherkin）:
  - シナリオ: 失敗したチェックはマージをブロックする
    - 前提: PR が作成されている
    - もし: lint/typecheck/unit/integration/E2E/build のいずれかが失敗する
    - ならば: PR はマージ不可の状態になる
  - シナリオ: 全チェックが成功した場合のみマージできる
    - 前提: PR が作成されている
    - もし: すべての CI チェックが成功する
    - ならば: PR はマージ可能な状態になる

## Task 2: Supabase マイグレーション検証の CI 組み込み
- 目的: マイグレーションが常に適用可能であることを CI で保証する。
- 作業内容:
  - CI で Supabase を起動し、`supabase db reset` で全マイグレーションを適用する。
  - マイグレーション後に `pnpm test:integration` を実行して RLS/CRUD が成立することを検証する。
  - 失敗時に原因が追跡できるようにログを保存/出力する。
- 自動テスト: 要（Integration + Migration Check）
- 受入基準（Gherkin）:
  - シナリオ: 新規環境でマイグレーションが適用できる
    - 前提: 空の Supabase 環境が起動している
    - もし: `supabase db reset` を実行する
    - ならば: すべてのマイグレーションがエラーなく適用される
  - シナリオ: マイグレーション後に統合テストが通る
    - 前提: マイグレーション適用済みの Supabase が起動している
    - もし: `pnpm test:integration` を実行する
    - ならば: RLS/CRUD を含む統合テストが成功する

## Task 3: Vercel デプロイの自動化（プレビュー/本番）
- 目的: 継続的デリバリーのパイプラインを完成させる。
- 作業内容:
  - GitHub と Vercel を連携し、PR でプレビュー、`main` で本番デプロイが行われる設定にする。
  - 必須環境変数（Supabase/Sentry など）を Vercel に登録する。
  - デプロイ通知（Vercel のステータスチェック）を CI の必須チェックに含める。
- 自動テスト: 不要（Vercel 側のデプロイステータスで担保）
- 受入基準（Gherkin）:
  - シナリオ: PR 作成時にプレビューが発行される
    - 前提: PR が作成されている
    - もし: Vercel のビルドが成功する
    - ならば: PR にプレビュー URL が表示される
  - シナリオ: `main` マージで本番デプロイが実行される
    - 前提: `main` に変更がマージされている
    - もし: Vercel のビルドが成功する
    - ならば: 本番環境に最新ビルドが反映される

## Task 4: Sentry（Browser）の導入と動作確認
- 目的: クライアントエラーの検知と通知を有効化する。
- 作業内容:
  - Sentry SDK を導入し、`NEXT_PUBLIC_SENTRY_DSN` で DSN を管理する。
  - クライアント側の初期化を行い、リリース/環境情報を付与できるようにする。
  - 意図的なエラー送信でイベントが Sentry に届くことを確認する。
- 自動テスト: 不要（手動確認）
- 受入基準（Gherkin）:
  - シナリオ: DSN が設定されていると Sentry にイベントが送信される
    - 前提: `NEXT_PUBLIC_SENTRY_DSN` が設定されている
    - もし: クライアントで意図的なエラーを送信する
    - ならば: Sentry にイベントが記録される
  - シナリオ: DSN 未設定時はエラー送信が無効化される
    - 前提: `NEXT_PUBLIC_SENTRY_DSN` が未設定である
    - もし: クライアントでエラーが発生する
    - ならば: 送信が行われずアプリがクラッシュしない

## Task 5: Lighthouse CI によるパフォーマンス/アクセシビリティ簡易チェック
- 目的: 主要指標の劣化を検知し、品質回帰を防ぐ。
- 作業内容:
  - Lighthouse CI の設定を追加し、パフォーマンス/アクセシビリティ等のしきい値を定義する。
  - CI でビルド後に Lighthouse を実行し、しきい値未達の場合は失敗させる。
  - 対象ページは `/` と `/inputs` を優先し、最低限の代表ページを計測する。
- 自動テスト: 要（Lighthouse CI）
- 受入基準（Gherkin）:
  - シナリオ: しきい値を下回ると CI が失敗する
    - 前提: Lighthouse のしきい値が設定されている
    - もし: いずれかの指標がしきい値未達となる
    - ならば: CI が失敗する
  - シナリオ: しきい値を満たすと CI が成功する
    - 前提: Lighthouse のしきい値が設定されている
    - もし: すべての指標がしきい値以上となる
    - ならば: CI が成功する
