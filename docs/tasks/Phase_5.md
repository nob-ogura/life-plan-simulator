# フェーズ5 タスク一覧（入力UI /inputs）

対象: `docs/Plan.md` の「フェーズ5: 入力UI（/inputs）」

## Task 1: /inputs 画面の骨格とセクション構成の実装
- 目的: 仕様どおりの入力セクションを持つ /inputs 画面を用意し、UI 導線を確立する。
- 作業内容:
  - `/inputs` ルートにフォーム画面を実装し、セクションをアコーディオンで表示する。
  - セクション順序: 家族構成 / 収入 / ボーナス / 支出 / 住宅 / ライフイベント / 退職金 / 年金開始年齢 / 投資設定 / シミュレーション設定。
  - 既存データをロードし、未入力でも安全に表示できる状態を整える。
- 受入基準（Gherkin）:
  - シナリオ: /inputs で全セクションが表示される
    - 前提: ログイン済みユーザーである
    - もし: `/inputs` を開く
    - ならば: すべてのセクションがアコーディオンとして表示される
    - かつ: 既存データがあれば初期値として反映される

## Task 2: react-hook-form + zod のフォーム基盤と日本語バリデーション
- 目的: 全入力の型安全なバリデーションと日本語エラーメッセージを統一する。
- 作業内容:
  - 各セクションの zod スキーマを定義し、Resolver で react-hook-form に接続する。
  - 必須・数値・年月（YYYY-MM）などの入力制約を日本語メッセージで表示する。
  - サーバーアクションに送るペイロードをセクション単位で整形する。
- 受入基準（Gherkin）:
  - シナリオ: 必須項目未入力で保存できない
    - 前提: 必須項目が未入力である
    - もし: 保存ボタンを押す
    - ならば: 保存処理が実行されない
    - かつ: 日本語のバリデーションメッセージが表示される

## Task 3: 家族構成フォーム（本人・配偶者・子ども）
- 目的: 100歳終端計算に必要な生年月情報と子ども情報を確実に登録できるようにする。
- 作業内容:
  - 本人/配偶者の生年月（年・月）を必須入力として扱う。
  - 子どもは複数行で追加・削除できるフォームを実装する。
  - 子どもは `birth_year_month` または `due_year_month` のいずれか必須とする。
- 受入基準（Gherkin）:
  - シナリオ: 本人/配偶者の生年月が必須となる
    - 前提: 本人または配偶者の生年月が未入力である
    - もし: 家族構成を保存する
    - ならば: 保存できない
    - かつ: 日本語の必須エラーが表示される
  - シナリオ: 子ども行で出生済みか誕生予定のいずれかが必須となる
    - 前提: 子ども行で `birth_year_month` と `due_year_month` が両方未入力である
    - もし: 家族構成を保存する
    - ならば: 保存できない
    - かつ: いずれか必須のエラーが表示される

## Task 4: 収入・ボーナス・支出フォームの実装
- 目的: 月次収入・ボーナス・支出の登録を UI から行えるようにする。
- 作業内容:
  - 収入フォームで手取り月額、昇給率、期間、ボーナス月/金額/変化点を入力可能にする。
  - 支出フォームで月額、インフレ率、期間、カテゴリを入力可能にする。
  - 収入/支出の追加・編集・削除を行い、保存時に Supabase へ upsert する。
- 受入基準（Gherkin）:
  - シナリオ: 収入とボーナスが保存できる
    - 前提: 収入フォームに必要項目が入力されている
    - もし: 収入を保存する
    - ならば: 入力内容が再読み込み後も保持される
  - シナリオ: 支出が保存できる
    - 前提: 支出フォームに必要項目が入力されている
    - もし: 支出を保存する
    - ならば: 入力内容が再読み込み後も保持される

## Task 5: 住宅・ローン・家賃フォームの実装
- 目的: 住宅購入と賃貸情報を UI から登録できるようにする。
- 作業内容:
  - 住宅購入フォームで建物価格/土地価格/頭金/返済年数/金利を入力できるようにする。
  - 賃貸フォームで家賃と期間を入力できるようにする。
  - 住宅購入の必須項目（建物/土地/頭金/返済年数）をバリデーションする。
- 受入基準（Gherkin）:
  - シナリオ: 住宅購入の必須項目が不足している場合は保存できない
    - 前提: 住宅購入フォームの必須項目が未入力である
    - もし: 住宅情報を保存する
    - ならば: 保存できない
    - かつ: 日本語の必須エラーが表示される

## Task 6: ライフイベント一覧・追加モーダルと排他ルール
- 目的: 汎用イベントを登録でき、退職金の排他ルールを UI で担保する。
- 作業内容:
  - イベント一覧ページ（`/events` または `/inputs` 内タブ）を実装する。
  - 追加モーダルで繰り返しイベント（間隔/回数）とカテゴリを入力できるようにする。
  - `retirement_bonus` は汎用イベントから新規追加不可とし、既存編集時は専用フォームへ誘導または警告を表示する。
- 受入基準（Gherkin）:
  - シナリオ: 汎用イベントで退職金カテゴリが追加できない
    - 前提: 汎用イベントの追加モーダルを開いている
    - もし: カテゴリに `retirement_bonus` を選択する
    - ならば: 選択できない、または選択時に専用フォームへの誘導が表示される
  - シナリオ: 繰り返しイベントを登録できる
    - 前提: イベント追加モーダルで繰り返し設定が入力されている
    - もし: イベントを保存する
    - ならば: 再読み込み後もイベントが一覧に表示される

## Task 7: 退職金専用フォーム（単一レコード）
- 目的: 退職金を単一レコードとして管理し、汎用イベントと排他にする。
- 作業内容:
  - 退職金フォームで金額と年月を入力できるようにする。
  - 保存時は `life_events` の `retirement_bonus` を 1 件のみ upsert する。
  - 既存レコードがある場合は更新のみ可能にする。
- 受入基準（Gherkin）:
  - シナリオ: 退職金は 1 件のみ保持される
    - 前提: 退職金フォームに入力がある
    - もし: 退職金を保存する
    - ならば: `retirement_bonus` のレコードが 1 件のみ存在する
    - かつ: 再保存しても追加ではなく更新になる

## Task 8: 投資設定・年金開始年齢・シミュレーション設定 UI
- 目的: assets と simulation_settings を UI から編集できるようにする。
- 作業内容:
  - 投資設定（現金/運用残高、運用利回り）を入力できるフォームを実装する。
  - 年金開始年齢（profiles.pension_start_age）を入力できるフォームを実装する。
  - 係数設定（年金額、諸係数）を編集できる設定 UI を追加する。
- 受入基準（Gherkin）:
  - シナリオ: 投資設定とシミュレーション設定が保存できる
    - 前提: 投資設定と係数設定に有効な値が入力されている
    - もし: 保存する
    - ならば: 再読み込み後も入力値が保持される

## Task 9: AutoSave と明示的保存（Upsert）フロー
- 目的: ローカル状態と Supabase への保存を切り分け、最新設定のみを保持する。
- 作業内容:
  - 変更時にローカルステートを更新し、明示的な保存ボタンで upsert を実行する。
  - 保存後にトーストや状態表示で成功を通知する。
  - 履歴は保持せず常に最新設定に上書きする挙動を統一する。
- 受入基準（Gherkin）:
  - シナリオ: 明示的保存で最新設定のみが保持される
    - 前提: 既存データが保存されている
    - もし: 入力を変更して保存する
    - ならば: 以前の値は上書きされる
    - かつ: 追加の履歴データは生成されない

## Task 10: 入力UI の E2E シナリオ整備（Playwright）
- 目的: 主要フォームの入力→保存→再取得の流れを自動化で保証する。
- 作業内容:
  - 家族構成（本人/配偶者の生年月）、収入、支出、退職金、シミュレーション設定の入力フローをテストする。
  - 未入力時の保存不可（バリデーション）を E2E で検証する。
  - ログイン後のユーザーデータのみ取得・編集できることを検証する。
- 受入基準（Gherkin）:
  - シナリオ: 入力→保存→再取得が成功する
    - 前提: ログイン済みユーザーである
    - もし: 主要フォームに入力して保存する
    - ならば: 再読み込み後も入力値が表示される
  - シナリオ: 必須項目が未入力の場合に保存できない
    - 前提: 本人/配偶者の生年月が未入力である
    - もし: 保存を試みる
    - ならば: 保存できない
    - かつ: バリデーションメッセージが表示される
