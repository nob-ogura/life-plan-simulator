# フェーズ4 タスク一覧（シミュレーションエンジン・フロント）

対象: `docs/Plan.md` の「フェーズ4: シミュレーションエンジン（フロント）」

## Task 1: シミュレーションドメインの骨格と入出力モデル定義
- 目的: 共有ドメインとして純粋関数の計算エンジンを配置し、VSA の責務分離を明確にする。
- 作業内容:
  - `src/shared/domain/simulation` に計算エンジンの入口と主要関数を配置する。
  - 入力（profiles / simulation_settings / 各入力テーブルの配列）と出力（月次配列）の型を定義する。
  - スライス固有の DTO は `src/features` 側に閉じ、ドメインは共有モデルのみを参照する。
- 受入基準（Gherkin）:
  - シナリオ: ドメインロジックが共有領域に集約されている
    - 前提: `src/shared/domain/simulation` が存在する
    - もし: シミュレーションの入口関数と型定義を確認する
    - ならば: 入口関数が純粋関数として実装されている
    - かつ: スライス固有の DTO を参照していない

## Task 2: 月次タイムライン生成ユーティリティの実装
- 目的: Date オブジェクトを使わず、年月文字列と経過月数で安定した月次配列を生成する。
- 作業内容:
  - `YYYY-MM` 文字列と経過月数を相互変換できるユーティリティを実装する。
  - 現在年月 + `start_offset_months` を開始月とし、`end_age`（既定 100 歳）までの月次配列を生成する。
  - 年齢計算は `profiles` の生年月に基づき、タイムラインと紐づけて扱える形にする。
- 受入基準（Gherkin）:
  - シナリオ: 月次タイムラインが仕様通り生成される
    - 前提: 現在年月と `start_offset_months` が与えられている
    - もし: タイムライン生成関数を実行する
    - ならば: 開始月が「現在年月 + start_offset_months」になっている
    - かつ: 年齢が `end_age` に到達する月で配列が終了する
    - かつ: `Date` オブジェクトに依存しない

## Task 3: 収入・ボーナス・年金・退職金の計算ロジック
- 目的: 手取りベースの収入計算と単一変化点ボーナス・年金・退職金の条件を実装する。
- 作業内容:
  - 収入は `start_year_month`〜`end_year_month` の期間内のみ計上する。
  - 昇給率は `take_home_monthly × (1 + raise_rate)^(経過年数)` で計算する。
  - ボーナスは指定月に `bonus_amount` を計上し、`change_year_month` 以降は `bonus_amount_after` を適用する。
  - 年金は `pension_start_age` 以降、`simulation_settings` の年金額を月次収入として加算する。
  - 退職金は `life_events` の `retirement_bonus` を指定月に一度だけ収入として計上する。
- 受入基準（Gherkin）:
  - シナリオ: 収入とボーナスが期間・変化点に沿って計算される
    - 前提: 収入データに昇給率とボーナス変化点が設定されている
    - もし: 月次収入を計算する
    - ならば: 期間外の月には収入が計上されない
    - かつ: 昇給率が経過年数で累乗される
    - かつ: `change_year_month` 以降は `bonus_amount_after` が適用される
  - シナリオ: 年金と退職金が正しく反映される
    - 前提: `pension_start_age` と `retirement_bonus` のイベントが設定されている
    - もし: 月次収入を計算する
    - ならば: 年金は `simulation_settings` の値で加算される
    - かつ: 退職金は指定月に一度だけ計上される

## Task 4: 支出・家賃と auto_toggle ロジックの実装
- 目的: 支出のインフレ計算と家賃停止ロジックを正しく反映する。
- 作業内容:
  - 支出は `start_year_month`〜`end_year_month` の期間内のみ計上する。
  - インフレ率は `amount_monthly × (1 + inflation_rate)^(経過年数)` で計算する。
  - `HOUSING_PURCHASE_STOP_RENT` が発生した場合、対象 rental を住宅購入月の前月で終了させる。
- 受入基準（Gherkin）:
  - シナリオ: 支出がインフレ率と期間条件で計算される
    - 前提: 支出データにインフレ率と期間が設定されている
    - もし: 月次支出を計算する
    - ならば: 期間外の月には支出が計上されない
    - かつ: インフレ率が経過年数で累乗される
  - シナリオ: 住宅購入で家賃が自動停止する
    - 前提: `HOUSING_PURCHASE_STOP_RENT` のイベントが住宅購入月に設定されている
    - もし: 家賃を含む月次支出を計算する
    - ならば: 住宅購入月の前月で家賃が終了する

## Task 5: ライフイベント展開と住宅ローン・固定資産税計算
- 目的: イベント展開と住宅購入時のローン・税額計算を一貫して行う。
- 作業内容:
  - `life_events` をタイムラインに展開し、`repeat_interval_years` と `stop_after_occurrences` を考慮する。
  - 住宅購入イベントでは `building_price` / `land_price` / `down_payment` を必須として扱う。
  - principal を `(building + land) × mortgage_transaction_cost_rate − down_payment` で算出する。
  - 固定資産税を `(building + land) × real_estate_evaluation_rate × real_estate_tax_rate / 12` で月次計上する。
  - 諸係数はすべて `simulation_settings` を参照し、ハードコードを避ける。
- 受入基準（Gherkin）:
  - シナリオ: 繰り返しイベントが停止条件まで展開される
    - 前提: `repeat_interval_years` と `stop_after_occurrences` が設定されている
    - もし: イベント展開を実行する
    - ならば: 指定回数でイベント生成が停止する
  - シナリオ: 住宅ローンと固定資産税が設定値で計算される
    - 前提: `simulation_settings` に諸係数が設定されている
    - もし: 住宅購入イベントを処理する
    - ならば: principal が諸経費率を用いて算出される
    - かつ: 固定資産税が月割りで計上される
    - かつ: 係数がハードコードされていない

## Task 6: 資産推移と枯渇月判定の実装
- 目的: 月次キャッシュフローから資産推移と枯渇月を算出する。
- 作業内容:
  - 月次収支を cash_balance に反映し、不足分を investment_balance から補填する。
  - investment_balance のみに `(1 + return_rate/12)` を適用する。
  - total_balance が初めて 0 未満になる月を枯渇月として記録する。
- 受入基準（Gherkin）:
  - シナリオ: cash と investment の資金移動が正しく反映される
    - 前提: cash と investment の初期残高が設定されている
    - もし: 月次収支を適用する
    - ならば: cash がマイナスの場合は investment から補填される
    - かつ: cash には利回りが適用されない
    - かつ: investment のみに利回りが適用される
  - シナリオ: 枯渇月が最初のマイナス月として記録される
    - 前提: 資産がマイナスになるシナリオが存在する
    - もし: 資産推移を計算する
    - ならば: total_balance が初めて 0 未満になる月が枯渇月として記録される

## Task 7: シミュレーション境界値テスト（Vitest）
- 目的: 主要な境界ケースで計算の正しさを保証する。
- 作業内容:
  - ボーナス変化点、繰り返しイベント、住宅購入による家賃停止、利回りと取り崩し、100 歳終端をテストする。
  - 退職金が指定月に一度だけ計上されることをテストする。
  - 年金額・諸係数が `simulation_settings` から参照されることをテストする。
- 受入基準（Gherkin）:
  - シナリオ: 境界値テストがすべてパスする
    - 前提: Vitest のテストケースが追加されている
    - もし: `pnpm test:unit` を実行する
    - ならば: ボーナス変化点・繰り返しイベント・家賃停止・利回り・100 歳終端のテストがグリーンになる
    - かつ: 退職金が指定月に一度だけ計上されるテストが通る
    - かつ: 年金額と諸係数が `simulation_settings` を参照するテストが通る
