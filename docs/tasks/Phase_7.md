# フェーズ7 タスク一覧（住宅イベント・自動停止ロジック強化）

対象: `docs/Plan.md` の「フェーズ7: 住宅イベント・自動停止ロジック強化」

## Task 1: 住宅購入による家賃停止ロジックの優先順位整理
- 目的: 単一 rental 前提の家賃停止が、ユーザーが編集した終了月と矛盾しないようにする。
- 作業内容:
  - `HOUSING_PURCHASE_STOP_RENT` のイベント発生月から「前月」を停止月として算出する。
  - rental の `end_year_month` が既に設定されている場合は、停止月と比較して早い方を採用する（延長は行わない）。
  - 繰り返しイベントの展開後に最も早い住宅購入イベントを基準にする（単一 rental 前提）。
- 自動テスト: 要（ユニット: `src/shared/domain/simulation` の家賃停止ロジックで、早期終了が優先されるケースを検証する）。
- 受入基準（Gherkin）:
  - シナリオ: 住宅購入より前に終了月が設定されている場合は終了月が優先される
    - 前提: rental の `end_year_month` が住宅購入月より前に設定されている
    - もし: シミュレーションを実行する
    - ならば: 家賃の計上は `end_year_month` で終了する
  - シナリオ: 住宅購入が終了月より前に発生した場合は住宅購入による停止が優先される
    - 前提: rental の `end_year_month` が住宅購入月より後に設定されている
    - もし: シミュレーションを実行する
    - ならば: 家賃の計上は住宅購入月の前月で終了する

## Task 2: 住宅購入係数の反映をテストで保証する
- 目的: 住宅ローン諸経費率・固定資産税率・評価額掛目が `simulation_settings` の値で計算されることを明示的に保証する。
- 作業内容:
  - `simulation_settings` の係数を使って principal と固定資産税が算出されていることを確認するテストを追加する。
  - 係数が変更された場合に、住宅購入イベントの計算結果が追従して変化することを検証する。
- 自動テスト: 要（ユニット: `life-events.test.ts` などで係数変更の反映を検証する）。
- 受入基準（Gherkin）:
  - シナリオ: 諸経費率が principal に反映される
    - 前提: `simulation_settings.mortgage_transaction_cost_rate` に任意の値が設定されている
    - もし: 住宅購入イベントの principal を計算する
    - ならば: principal が設定値に基づいた結果になる
  - シナリオ: 固定資産税率と評価額掛目が月次税額に反映される
    - 前提: `simulation_settings.real_estate_tax_rate` と `simulation_settings.real_estate_evaluation_rate` が設定されている
    - もし: 住宅購入イベントの固定資産税を計算する
    - ならば: 月次固定資産税が設定値に基づいた結果になる

## Task 3: 繰り返しイベントの停止条件（回数/年齢）をドメインに反映する
- 目的: 繰り返しイベントが回数または年齢の停止条件で正しく打ち切られるようにする。
- 作業内容:
  - 必要に応じて `life_events` に `stop_after_age`（例: 年齢の上限）を追加し、型・Zod スキーマを更新する。
  - プロフィールの生年月を用いて、イベントの停止年齢から停止年月を算出するロジックを追加する。
  - `stop_after_occurrences` と `stop_after_age` の両方が設定されている場合は、より早く到達する条件で停止する。
- 自動テスト: 要（ユニット: 繰り返しイベントの停止条件が回数/年齢で正しく効くことを検証する）。
- 受入基準（Gherkin）:
  - シナリオ: 回数の停止条件で繰り返しイベントが止まる
    - 前提: `repeat_interval_years` と `stop_after_occurrences` が設定されている
    - もし: イベント展開を実行する
    - ならば: 指定回数を超えてイベントが生成されない[]
  - シナリオ: 年齢の停止条件で繰り返しイベントが止まる
    - 前提: `repeat_interval_years` と `stop_after_age` が設定されている
    - もし: イベント展開を実行する
    - ならば: 指定年齢を超える月のイベントが生成されない
  - シナリオ: 回数と年齢の両方がある場合は早い方で停止する
    - 前提: `stop_after_occurrences` と `stop_after_age` の両方が設定されている
    - もし: イベント展開を実行する
    - ならば: より早く到達する条件でイベント生成が停止する

## Task 4: ライフイベント入力UIの停止条件入力・表示を拡張する
- 目的: UI 上で繰り返しイベントの停止条件（回数/年齢）を設定でき、表示上も一致させる。
- 作業内容:
  - `LifeEventAddModal` などの入力フォームに停止条件（回数/年齢）を追加する。
  - 回数・年齢いずれも未入力の場合は無制限扱いとし、入力値は正の整数・年齢範囲（0-120）を検証する。
  - `action.ts` 経由で更新するフローを維持し、UI から直接 `supabaseClient` を呼ばない。
  - 一覧表示（繰り返し表記など）に停止条件のサマリを追加する。
- 自動テスト: 不要（停止条件の整合性は Task 3 のユニットテストと Task 5 のE2Eで担保する）。
- 受入基準（Gherkin）:
  - シナリオ: 停止条件（回数/年齢）が入力フォームに反映される
    - 前提: ライフイベント追加モーダルを開いている
    - もし: 停止条件（回数または年齢）を入力して保存する
    - ならば: 保存されたイベントに停止条件が保持される
  - シナリオ: 停止条件が一覧表示に反映される
    - 前提: 繰り返しイベントが登録されている
    - もし: ライフイベント一覧を表示する
    - ならば: 繰り返し条件と停止条件が表示される

## Task 5: 住宅購入・繰り返しイベントの連動をE2Eで保証する
- 目的: UI と計算結果が一致していることをエンドツーエンドで保証する。
- 作業内容:
  - Playwright で「住宅購入イベント追加 → 家賃停止」シナリオを追加する。
  - Playwright で「繰り返しイベントの停止条件（回数/年齢）」が反映されるシナリオを追加する。
  - ダッシュボードの月次表・サマリなど、ユーザーが確認可能な箇所で結果を検証する。
- 自動テスト: 要（E2E: `tests/e2e` にシナリオを追加する）。
- 受入基準（Gherkin）:
  - シナリオ: 住宅購入で家賃が購入月の前月に停止する
    - 前提: 賃貸の開始月が入力されている
    - かつ: 住宅購入イベントが登録されている
    - もし: ダッシュボードを表示する
    - ならば: 家賃の計上が住宅購入月の前月で停止している
  - シナリオ: 繰り返しイベントが停止条件で打ち切られる
    - 前提: 繰り返しイベントに停止条件（回数または年齢）が設定されている
    - もし: ダッシュボードを表示する
    - ならば: 停止条件を超える月にはイベントが計上されない
