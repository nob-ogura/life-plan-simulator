# フェーズ7 タスク一覧（住宅イベント・自動停止ロジック強化）

対象: `docs/Plan.md` の「フェーズ7: 住宅イベント・自動停止ロジック強化」

## Task 1: 住宅購入イベントの家賃停止ルール（単一 rental 前提）
- 目的: 住宅購入イベントで家賃停止が自動で適用される前提を明確にする。
- 作業内容:
  - 住宅購入カテゴリのライフイベント入力では停止対象の選択UIを設けない。
  - `auto_toggle_key` が `HOUSING_PURCHASE_STOP_RENT` の場合、登録済みの rental を住宅購入月の前月で停止する。
  - UI からの直接 Supabase 更新は行わず、スライスの Command を経由する。
- 自動テスト: 要（E2E: 住宅購入イベントを追加し、家賃停止が反映されることを確認する）。
- 受入基準（Gherkin）:
  - シナリオ: 住宅購入イベントで家賃停止が自動で適用される
    - 前提: rental が登録されている
    - もし: 住宅購入イベントを追加して保存する
    - ならば: rental の終了月が購入月の前月に更新される

## Task 2: 繰り返しイベントの停止条件（年齢）のデータモデルとUI追加
- 目的: 繰り返しイベントを年齢条件で停止できるようにする。
- 作業内容:
  - `life_events` に年齢停止用のカラム（例: `stop_after_age`）を追加するマイグレーションを作成する。
  - Supabase 型生成を更新し、Request/Validation/Repository に新フィールドを反映する。
  - ライフイベント入力UIに「停止年齢（本人）」を追加し、数値・範囲（0-120）を検証する。
  - 一覧表示に年齢停止条件を表示する（例: 「停止条件: 65歳」）。
- 自動テスト: 要（統合テスト: CRUD で `stop_after_age` が保存/取得できることを確認する）。
- 受入基準（Gherkin）:
  - シナリオ: 年齢停止条件が保存・表示できる
    - 前提: ライフイベントの停止年齢を入力している
    - もし: ライフイベントを保存する
    - ならば: `stop_after_age` が保存される
    - かつ: 一覧に停止年齢が表示される
  - シナリオ: 停止年齢が範囲外の場合は保存できない
    - 前提: 停止年齢に 0 未満または 121 以上の値を入力している
    - もし: 保存を実行する
    - ならば: バリデーションエラーが表示される

## Task 3: 繰り返しイベント展開の停止条件（回数/年齢）の計算強化
- 目的: 繰り返しイベントの展開停止を「回数」と「年齢」の両条件で判定できるようにする。
- 作業内容:
  - `shared/domain/simulation` のイベント展開ロジックに年齢停止条件を追加する。
  - `stop_after_occurrences` と `stop_after_age` の両方が指定された場合は、先に満たした条件で停止する。
  - 年齢判定は本人年齢（タイムラインの age）を利用する。
- 自動テスト: 要（ユニット: 回数・年齢の単独条件、併用条件での停止を検証する）。
- 受入基準（Gherkin）:
  - シナリオ: 停止回数で繰り返しが終了する
    - 前提: `repeat_interval_years` と `stop_after_occurrences` が設定されている
    - もし: イベント展開を実行する
    - ならば: 指定回数でイベント生成が停止する
  - シナリオ: 停止年齢で繰り返しが終了する
    - 前提: `repeat_interval_years` と `stop_after_age` が設定されている
    - もし: イベント展開を実行する
    - ならば: 本人年齢が停止年齢に到達した月以降はイベントが生成されない
  - シナリオ: 停止回数と停止年齢が併用された場合は早い方で停止する
    - 前提: `stop_after_occurrences` と `stop_after_age` の両方が設定されている
    - もし: イベント展開を実行する
    - ならば: 先に到達した停止条件でイベント生成が終了する

## Task 4: 住宅購入の家賃自動停止ロジック（早期終了の尊重）
- 目的: 単一 rental 前提で、end_month の編集による早期終了を尊重する。
- 作業内容:
  - 住宅購入月の前月を終了月とするが、すでに終了済みの場合は変更しない。
- 自動テスト: 要（ユニット: end_month の早期終了を尊重する分岐を検証する）。
- 受入基準（Gherkin）:
  - シナリオ: 早期終了済みの rental は上書きされない
    - 前提: 対象 rental の終了月が購入月より前に設定されている
    - もし: 住宅購入イベントを適用する
    - ならば: 既存の終了月が保持される

## Task 5: 住宅ローン・固定資産税計算の精緻化
- 目的: 住宅購入イベントの計算が `simulation_settings` の係数に正確に追従することを保証する。
- 作業内容:
  - 複数の住宅購入イベントでも `mortgage_transaction_cost_rate` / `real_estate_tax_rate` / `real_estate_evaluation_rate` を参照して計算する。
  - 住宅購入イベントごとの建物/土地/頭金を反映し、ローン元本と固定資産税を月次計上する。
  - ハードコード係数が残っていないことを確認する。
- 自動テスト: 要（ユニット: 設定係数が反映されることを複数イベントで検証する）。
- 受入基準（Gherkin）:
  - シナリオ: 係数が `simulation_settings` から参照される
    - 前提: 係数がカスタム値に設定されている
    - もし: 住宅購入イベントを計算する
    - ならば: ローン元本と固定資産税が設定値に基づいて算出される
  - シナリオ: 複数の住宅購入イベントに対して同じ係数が適用される
    - 前提: 住宅購入イベントが複数登録されている
    - もし: シミュレーションを実行する
    - ならば: すべての住宅購入イベントで同一の係数が適用される

## Task 6: 住宅イベント強化シナリオのE2E確認
- 目的: 住宅購入 + 繰り返しイベント停止条件が UI と計算で一致して動くことを保証する。
- 作業内容:
  - E2E で「住宅購入 + 家賃停止（単一 rental）」のシナリオを追加する。
  - 繰り返しイベントの停止条件（回数/年齢）が UI 入力と結果表示に反映されるシナリオを追加する。
- 自動テスト: 要（E2E: UI 入力からダッシュボード反映までを通貫で確認する）。
- 受入基準（Gherkin）:
  - シナリオ: 住宅購入イベントで rental が停止する
    - 前提: rental と住宅購入イベントが登録されている
    - もし: ダッシュボードを表示する
    - ならば: rental が購入月の前月で停止している
  - シナリオ: 繰り返しイベントの停止条件が UI と一致する
    - 前提: 繰り返しイベントに回数/年齢の停止条件を入力している
    - もし: ダッシュボードを表示する
    - ならば: 表示されるイベントが停止条件に一致する
