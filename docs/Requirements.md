# ライフプランシミュレータ Webアプリケーション要件定義書

## 1. プロジェクト概要
*   **目的**: ユーザーが自身の将来の収支、資産推移、ライフイベントを可視化し、金銭的な不安を解消するための「未来の設計図」を作成できるWebアプリケーションを開発する。
*   **ターゲット**: 将来の資金計画に不安を持つエンジニア（20代〜50代）。
*   **開発体制**: 個人開発（スモールスタートでMVP（Minimum Viable Product）を目指す）。

## 2. システムアーキテクチャ・技術選定
個人開発における学習コストの低減と、スケーラビリティ確保のため、以下の「モダンWeb開発」構成を採用します。

| レイヤー           | 技術選定                         | 選定理由                                                         |
| :----------------- | :------------------------------- | :--------------------------------------------------------------- |
| **フロントエンド** | **Next.js (React)**              | SEO、パフォーマンスに優れ、現在のWeb開発の主流。                 |
| **UIライブラリ**   | **Tailwind CSS** + **shadcn/ui** | デザインの一貫性と実装効率を担保するため。                       |
| **バックエンド**   | **Supabase**                     | 認証、DB、APIを統合的に提供するBaaS。SQLベースで集計処理が得意。 |
| **データベース**   | **PostgreSQL**                   | Supabaseに内包。リレーショナルデータ管理に最適。                 |
| **インフラ**       | **Vercel**                       | Next.jsの公式ホスティングでデプロイが容易。                      |

## 3. 機能要件
ライフプランシミュレーションに必要な入力・計算・出力機能を定義します。

### 3.1 入力機能（現状把握）
ユーザーが以下の情報を入力できるフォームを提供します。
*   **家族構成**: 本人、配偶者、子供の年齢、誕生予定。
*   **収入情報**: **手取り金額（計算ベース）**、**ボーナス支給月・手取り額**、退職金受取時期（年・月）、年金開始年齢。
    *   年収（総支給額）は入力不要とし、すべて手取りベースで扱う。
*   **支出情報**: 基本生活費（食費・光熱費など）、住居費（家賃・管理費）。
*   **資産・負債**: 現在の貯蓄額、投資資産、住宅ローン残高。
*   **ライフイベント**: 住宅購入、子供の進学、車の購入、旅行などの一時的支出。
    *   **繰り返し設定**: 車の買い替えや旅行など、定期的なイベントについては頻度（例：5年ごと）を設定可能にする。
*   **住宅購入入力**: 「建物価格」「土地価格」「頭金」「返済年数」を入力させ、ローンと固定資産税を概算する。

### 3.2 シミュレーション・計算ロジック
入力データに基づき、将来のキャッシュフローを**月次のみ**で計算します（年次集計は行わない）。
*   **月次計算**: ボーナス支給月には手取りボーナスを計上し、月ごとの収支変動を詳細にシミュレーションする。
*   **ボーナスの期間条件**: 原則「毎年同額・指定月に支給」とし、オプションで「指定年以降にゼロまたは増額」の単一変化点を許容する。
*   **変動要因の反映**:
    *   **インフレ率**: 支出に手取りベースでそのまま乗算する。
    *   **昇給率**: 手取り収入にそのまま乗算して増減させる（税・社保は再計算しない）。初期値は保守的に0〜1%/年を推奨。
    *   **運用利回り**: 資産運用の複利効果を反映する。
*   **ライフイベントの反映**: イベント発生年（または月）に、設定された金額を一時的な収支として計上する。
    *   **費目の自動連動**: 住宅購入イベント発生時には現在の家賃支出を停止するなど、イベントと固定費の連動ロジックを実装する。
    *   **繰り返しイベント**: 設定された頻度に基づき、将来にわたって定期的な支出を自動生成する。
*   **税・社会保険料**: 自動計算ロジックは実装せず、ユーザー入力による手取り額を用います。
*   **シミュレーション期間**: 計算終了年齢を固定で100歳とする。
*   **退職金**: 一時金として扱い、受取年・月を入力させて該当月に計上する。
*   **年金**: ユーザーが開始年齢のみ設定し、金額はモデル値を使用する。標準は月65,000円/人（年78万円）。配偶者がいる場合は月130,000円（年156万円）を適用する。

#### 住宅ローン・固定資産税の概算ルール
*   **ローン計算**: 建物+土地+諸費用（物件価格の3%）から頭金を差し引き、固定金利1.5%・元利均等・指定返済年数で月々の返済額を算出する。
*   **固定資産税**: 課税標準＝(建物価格×0.7 + 土地価格×0.7)、税率1.4%。経年減価は考慮せず毎年同額を月割り計上する。

### 3.3 可視化・出力機能（UI/UX）
計算結果を直感的に理解できるインターフェースを提供します。
*   **キャッシュフロー表（全て月次）**: 将来にわたる月次収支、貯蓄残高の推移を表形式で表示。
*   **資産推移グラフ（全て月次データ）**: 資産寿命（資金が尽きる月）を一目でわかる折れ線グラフや棒グラフで表示。
*   **表示範囲フィルタ**: 「直近5年」「全期間」を切替可能。
*   **サマリカード**: 表示範囲の「累計収支」「平均月残高」「資産寿命（枯渇月）」を上部に固定表示し、長期月次表示の可読性を補完する。

## 4. 非機能要件
個人開発であっても、金融データを扱うため高い信頼性とセキュリティが求められます。

### 4.1 セキュリティ
*   **認証・認可**: Supabase Authを使用し、GitHub アカウントによるログインを実装。
    *   **ログイン必須**: データの永続性を保証するため、ゲスト利用（未ログイン利用）は提供せず、利用にはログインを必須とします。
*   **データ隔離 (Row Level Security)**: SupabaseのRLS（行レベルセキュリティ）を有効化し、ユーザーが自分自身のデータしか閲覧・操作できないようデータベースレベルで強制する。
    *   ポリシー例: `auth.uid() = user_id` の条件でのみSELECT/UPDATEを許可。
*   **入力検証**: バリデーションライブラリを用い、不正な数値入力をフロントエンド・バックエンド双方で防ぐ。

### 4.2 パフォーマンス
*   **インデックス最適化**: 頻繁にクエリされる `user_id` などのカラムにインデックスを貼り、RLSのパフォーマンス低下を防ぐ。

### 4.3 運用・保守
*   **CI/CD**: GitHub ActionsとVercelを連携させ、mainブランチへのマージを契機に自動デプロイを行う。
*   **エラー監視**: Sentryなどを導入し、ユーザー側で起きたクラッシュやエラーを検知する。

## 5. 開発の進め方（ロードマップ）
1.  **バードアイ図（全体像）の作成**: 画面遷移とデータフロー（ユーザー入力→計算→グラフ表示）を整理する。
2.  **プロトタイプ作成**: まずは主要な数値入力と単純なグラフ表示のみを行うMVPを作成し、デプロイする。
3.  **機能拡張**: ユーザーからのフィードバックや自身のテストに基づき、税金計算の精度向上やシナリオ比較機能を追加する。
4.  **運用改善**: ログ監視を行いながら、データベースのパフォーマンスチューニングを実施する。
