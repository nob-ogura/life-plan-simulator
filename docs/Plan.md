# 実装計画

## フェーズ0: バードアイ図と全体整理
- 目的: 要件定義書5.1の「バードアイ図（画面遷移とデータフロー）」を先行で可視化し、以降の設計で迷子にならないようにする。
- 実装内容:
  - 画面遷移図（未ログイン→ログイン→入力→ダッシュボード）とデータフロー（入力→計算エンジン→可視化）を作成。
  - 主要エンティティ（income/expenses/life_events/mortgages 等）と Supabase テーブル対応を紐付けたMermaid図を作成し、 Design.md に追記。
- DOD:
  - Mermaid図が Design.md に追加される。
  - 入力→計算→表示の流れをMermaid図だけで把握できる。

## フェーズ1: 基盤セットアップ
- 目的: Next.js 14 + TypeScript + Tailwind CSS + shadcn/ui + Supabase クライアントの開発基盤を整備し、VSA で拡張しやすい骨格を作る。
- 実装内容:
  - App Router 構成でプロジェクト初期化、`src/features/<module>/<slice>/` で機能を束ねるフォルダ構成と RER 雛形（request/endpoint/response）を準備。横断関心は `src/shared` のみに置く。
  - Tailwind/shadcn/ui の導入とテーマ設定、グローバルレイアウト/ヘッダー/トーストを整備。
  - Supabase JS クライアント、環境変数テンプレート `.env.example` 整備、型生成（`supabase gen types typescript`）。
  - Lint/Format/Test (Biome/Vitest) 設定、ローカル検証と GitHub Actions での最小CI（lint + typecheck + unit）の雛形を追加。
- DOD:
  - `pnpm lint`, `pnpm test` が通り、開発サーバーが起動すること。
  - `.env.example` に必要キーが揃い、README にセットアップ手順を記載。
  - `src/features` 配下のスライス雛形が存在し、`shared` には横断関心のみが置かれている（ドメイン共有を除く）。

## フェーズ2: 認証・RLS基盤
- 目的: ログイン必須要件を満たし、ユーザーデータを RLS で隔離できる状態を作る。
- 実装内容:
  - Supabase Auth (GitHub OAuth) 設定、ログイン/ログアウトフローと保護ルートガードを実装。
  - `profiles` と `simulation_settings` のスキーマを Supabase migration で先行作成し、`on_auth_user_created` トリガーで初期レコードを自動作成する SQL を配置。
  - 上記2テーブルに RLS を有効化し、`auth.uid() = user_id` ポリシーを作成。
- DOD:
  - 未ログイン時は `/login` へ誘導され、ログイン後にダッシュボードへ遷移する。
  - Supabase migration が適用済みで、`profiles` と `simulation_settings` に RLS ポリシーが有効。
  - 認証状態の取得とセッション更新がフロント全体で一貫して動作する。

## フェーズ3: データモデル & CRUD スライス
- 目的: 入力データを永続化できる最小の API/ストアを揃え、以降の UI/計算の土台にする。
- 実装内容:
  - テーブル: `children`, `income_streams`, `expenses`, `rentals`, `assets`, `mortgages`, `life_events`, `retirement_benefits` (退職金受取年・月、金額)、`pensions` (年金開始年齢・モデル月額) のスキーマとインデックスを Supabase migration として作成（`profiles` / `simulation_settings` はフェーズ2で作成済み）。
  - 制約/標準化: すべての日付は月初 (`YYYY-MM-01`) に正規化、金額は `amount >= 0`、`repeat_interval_years > 0`、`children` は `birth_year_month` または `due_year_month` のどちらか必須、`life_events(year_month)` にインデックスを付与。
  - 各スライスで RER 構成の API エンドポイント/サーバーアクションを用意し、zod で入出力バリデーションを実装。Endpoint は入出力/認証のみ、Handler がオーケストレーション、計算や整合性ルールは Entity/ValueObject に寄せる。
  - CQRS を明示採用: 書き込みは Command Handler、読み取りは Query Handler とし、Query は Supabase の非トラッキング/軽量プロジェクションで最適化。
  - データアクセスはスライス内の小さな Repository/Infrastructure クラスに限定し、他スライスからの直接参照は禁止。
  - 共通 DTO/型は shared ではなくスライス内に保持（計算で共有するドメイン型のみ `shared/domain` に配置）。同種のグルーコードが 3 回以上重複した場合のみ shared への抽出を検討（Rule of Three）。
  - RLS ポリシーと CRUD API を対象にした integration テスト/手順を整備。
- DOD:
  - 上記テーブルの CRUD が動作し、RLS 下で自ユーザーのみ読み書きできる。
  - マイグレーションに日付正規化・金額/繰り返し/children の check constraint と `life_events(year_month)` インデックスが含まれている。
  - zod によるバリデーションエラー時に 400 を返却し、正常系は 200/204 を返す。
  - Migration を適用した Supabase プロジェクトで CRUD + RLS を含む `pnpm test:integration`（暫定）が通る。

## フェーズ4: シミュレーションエンジン（フロント）
- 目的: 要件に沿った月次キャッシュフロー計算を行う純粋関数を実装し、ドメインロジックを固める。
- 実装内容:
  - `shared/domain/simulation` にタイムライン生成、収入/支出/イベント展開、住宅ローン・固定資産税計算、年金・退職金、運用利回り、枯渇月判定を実装。
  - インフレ率は支出に単純乗算、昇給率は手取り収入に乗算し税・社保の再計算は行わない（手取りベース固定）。
  - ボーナスは「毎年同額＋指定月」を基本とし、単一の変化点（指定年以降ゼロまたは増額）のみ許容する。
  - 退職金: `retirement_benefits` の `year_month` に一致する月に一度だけ手取り収入として計上し、入力起点はフェーズ5の退職金フォームで取得したデータとする。
  - 年金・諸係数は `simulation_settings` の値を参照して適用（デフォルト値は DB 定義を利用しハードコードしない）。
  - 日付を `YYYY-MM` 文字列と経過月数で扱うユーティリティを追加（Date オブジェクトを避ける）。
  - `HOUSING_PURCHASE_STOP_RENT` の auto_toggle ロジックを組み込み、住宅購入月の前月で rental を自動終了させる。
  - Vitest で境界値テスト（ボーナス変化点、繰り返しイベント、住宅購入時家賃停止、利回りと取り崩し、100歳終端）を作成。
- DOD:
  - ドメイン関数が副作用なしでデータモデルを入力し、月次配列を返す。
  - 主要パスとエッジケースの単体テストがグリーン（住宅購入時家賃停止を含む）。
  - 退職金が指定月に一度だけ収入として反映されるテストが通る。
  - モデル値（年金）と計算係数（インフレ・昇給率・ボーナス変化点等）が `simulation_settings` から参照されている。
  - 計算に使用する係数が DB (`simulation_settings`) 由来であることを確認できる。

## フェーズ5: 入力UI（/inputs）
- 目的: ユーザーが要件の入力項目を漏れなく登録・更新できるフォームを提供する。
- 実装内容:
  - react-hook-form + zod Resolver で各セクション（家族構成/収入/ボーナス/支出/住宅/ライフイベント/退職金/年金開始年齢/投資設定/シミュレーション設定）のフォームを実装。
  - イベント一覧ページと追加モーダル（繰り返しイベント含む）を実装し、`/events` または `/inputs` 内タブとして提供。
  - 設定ページでモデル年金・係数（simulation_settings）を閲覧・編集できる UI を追加。
  - ステップ型アコーディオン UI、ローカルステート自動保存、明示的な「保存」ボタンで Supabase へ upsert。
  - 繰り返しイベント入力、住宅購入入力（建物/土地/頭金/返済年数）をサポートし、バリデーションメッセージを日本語で表示。
- DOD:
  - 各フォームで必須項目のバリデーションが機能し、保存後にデータが DB に反映される。
  - ログインユーザーのデータのみ取得・編集できることを UI から確認。
  - 主要なフォーム操作の Playwright/E2E シナリオが通る（入力→保存→再取得）。

## フェーズ6: ダッシュボード可視化（/）
- 目的: シミュレーション結果を直感的に理解できるダッシュボードを提供する。
- 実装内容:
  - サマリカード（累計収支・平均月残高・資産寿命）を実装し、表示範囲切替（直近5年/全期間）を実装。
  - 資産推移ラインチャートと月次キャッシュフロー表（仮想スクロール）を shadcn/ui + chart ライブラリで作成。
  - フロントで入力データを取得し、フェーズ4のエンジンを実行して描画するフローを構築。
- DOD:
  - 範囲切替がグラフと表の双方に反映される。
  - 枯渇月が表示され、資産がマイナスになるシナリオで正しくハイライトされる。
  - パフォーマンステストで 1,000 件規模の月次データでもフレーム落ちが顕著でない（目安 60fps 付近）。

## フェーズ7: 住宅イベント・自動停止ロジック強化
- 目的: 住宅購入イベントと家賃停止、繰り返しイベントの自動展開など、要件の連動ロジックを仕上げる。
- 実装内容:
  - 住宅購入ロジックを拡張: 複数 rental / `target_rental_id` 対応や例外ケース（途中解約など）を扱う。
  - 繰り返しイベントのタイムライン展開と停止条件（回数/年齢）の計算・UIを強化（フェーズ4のベース実装を発展）。
  - 住宅ローン諸経費率・固定資産税率・評価額掛目を `simulation_settings` から参照し、計算結果への反映を精緻化。
- DOD:
  - 複数 rental / target_rental_id など拡張ケースでも家賃停止ロジックが期待通り動作する。
  - 繰り返しイベントの停止条件（回数/年齢）が UI と計算で一致している。
  - 上記シナリオのドメイン単体テストと E2E の双方がグリーン。

## フェーズ8: 運用・品質保証
- 目的: リリース可能な品質を確保し、継続的デリバリーのパイプラインを完成させる。
- 実装内容:
  - CI: GitHub Actions で lint/typecheck/unit に加え、integration/E2E、Supabase migration チェック、Vercel へのプレビュー/本番デプロイを自動化（フェーズ1の最小CIを拡張）。
  - 監視: Sentry（Browser）導入、環境変数で DSN を管理、エラー通知を有効化。
  - パフォーマンス/アクセシビリティ簡易チェック（Lighthouse CI など）を追加し、主要指標のしきい値を設定。
- DOD:
  - `main` へのマージで自動的に Vercel へデプロイされる。
  - CI が lint/test/build を通過しない限りマージできない状態。
  - Sentry が稼働し、意図的なエラー送信でイベントを確認済み。

## フェーズ9: 拡張ロードマップ（税精度向上・シナリオ比較）
- 目的: 要件定義書5.3の「税精度向上・シナリオ比較」を継続拡張として位置付け、後続フェーズの指針を明確にする。
- 実装内容:
  - 手取りベースから段階的に源泉税・社保を再計算するオプションを追加し、計算コストに応じて on/off できる設計にする。
  - シナリオ比較（ベースライン vs 代替シナリオ）を2系統の入力/計算/可視化パイプラインとして実装し、差分ハイライトを行う。
- DOD:
  - 税再計算オプションを有効/無効にした状態で主要テストが通る。
  - シナリオA/Bを切替えて累計収支・資産寿命の差分が表示できる。
