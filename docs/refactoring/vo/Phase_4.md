# フェーズ 4: ドメイン層での利用拡大 タスク一覧

> 参照: docs/ValueObject.md の「フェーズ 4: ドメイン層での利用拡大」

## 1. シミュレーションドメインへ YearMonth / Money を適用
- 作業内容
  - `src/shared/domain/simulation` の主要ロジックで `YearMonth` / `Money` を利用する
  - `YearMonth` の比較・加算・経過月数計算を VO のメソッド経由に寄せる
  - `Money` の演算・集計を VO 経由に寄せ、primitive の直接操作を削減する

- 受入基準（Gherkin）
```gherkin
機能: シミュレーションドメインのVO化

  シナリオ: シミュレーション結果が従来と一致する
    前提 同一の入力データがある
    もし YearMonth と Money をドメイン層で利用してシミュレーションを実行する
    ならば 従来の実装と同じ結果が得られる

  シナリオ: 年月の演算がVO経由で行われる
    前提 YearMonth.create("2025-01") がある
    もし addMonths(1) を実行する
    ならば 結果の toString() が "2025-02" になる
```
- 自動テスト要否: 要
  - 理由: ドメイン中核の挙動変更であり、回帰リスクが高い
  - 想定テスト: Vitest でシミュレーションの入力・出力一致テストを追加

## 2. timeline / 日付ユーティリティの責務を VO に移譲
- 作業内容
  - `src/shared/domain/simulation/timeline.ts` の `parseYearMonth` / `yearMonthToElapsedMonths` などを VO メソッドへ移す
  - 既存の関数は VO メソッド呼び出しに薄くするか、不要なら削除する
  - ドメイン層に正規表現ベースの検証が残らないようにする

- 受入基準（Gherkin）
```gherkin
機能: timeline のVO集約

  シナリオ: 年月の検証はVOに集約される
    前提 "2025-13" が無効なYearMonth文字列である
    もし ドメイン層で年月の検証を行う
    ならば YearMonth.create によってエラーになる

  シナリオ: timeline の演算はVOメソッドを通じて行われる
    前提 YearMonth.create("2024-12") がある
    もし 経過月数の変換を行う
    ならば VO のメソッドが利用される
```
- 自動テスト要否: 要
  - 理由: 日付計算の境界条件（年またぎ・月末）で不具合が出やすい
  - 想定テスト: Vitest で経過月数変換・加算の境界テストを追加

## 3. 境界層（DTO/DB）とのマッピング整理
- 作業内容
  - Supabase 型は `string` / `number` のまま維持する
  - Mapper / Handler で `YearMonth` / `Money` ⇄ primitive を明示変換する
  - Client/Server や API 境界では primitive を基本とし、VO は渡さない

- 受入基準（Gherkin）
```gherkin
機能: 境界層のVOマッピング

  シナリオ: DBからの年月はVOへ変換される
    前提 DB の year_month が "2025-06" である
    もし Mapper がドメインオブジェクトを生成する
    ならば YearMonth.create("2025-06") が使用される

  シナリオ: API境界ではprimitiveを返す
    前提 ドメインに YearMonth が存在する
    もし APIレスポンスを組み立てる
    ならば 年月は "YYYY-MM" の文字列になる
```
- 自動テスト要否: 条件付き
  - 理由: マッピングは単純だが、境界の不具合は検知が遅れやすい
  - 推奨: 既存の統合テストがあれば追加、難しければ最低限のユニットテストで保証

## 4. 回帰確認テストの整備
- 作業内容
  - 既存のシミュレーション結果に差分がないことを確認するテストを追加する
  - 重要な入力パターン（複数年・複数イベント・金額丸め）をカバーする

- 受入基準（Gherkin）
```gherkin
機能: VO化後の回帰確認

  シナリオ: 代表ケースで結果差分がない
    前提 代表的な入力データセットがある
    もし VO化後のシミュレーションを実行する
    ならば 結果が従来の期待値と一致する
```
- 自動テスト要否: 要
  - 理由: 変更範囲が広く、手動確認では網羅できないため
  - 想定テスト: Vitest の統合寄りテストで固定データの期待値比較
