import { describe, expect, it } from "vitest";
import { type SimulationInput, simulateLifePlan } from "@/shared/domain/simulation";

const createRegressionInput = (): SimulationInput => ({
  currentYearMonth: "2025-01",
  profiles: {
    birth_year: 1990,
    birth_month: 6,
    spouse_birth_year: 1992,
    spouse_birth_month: 11,
    pension_start_age: 65,
  },
  simulationSettings: {
    start_offset_months: 0,
    end_age: 37,
    pension_amount_single: 65000,
    pension_amount_spouse: 120000,
    mortgage_transaction_cost_rate: 1.05,
    real_estate_tax_rate: 0.014,
    real_estate_evaluation_rate: 0.71,
  },
  children: [],
  incomeStreams: [
    {
      take_home_monthly: 320000,
      bonus_months: [6, 12],
      bonus_amount: 400000,
      change_year_month: "2026-01",
      bonus_amount_after: 450000,
      raise_rate: 0.025,
      start_year_month: "2024-07",
      end_year_month: null,
    },
    {
      take_home_monthly: 180000,
      bonus_months: [7],
      bonus_amount: 200000,
      change_year_month: null,
      bonus_amount_after: null,
      raise_rate: 0.015,
      start_year_month: "2025-04",
      end_year_month: "2026-12",
    },
  ],
  expenses: [
    {
      amount_monthly: 210000,
      inflation_rate: 0.018,
      category: "living",
      start_year_month: "2024-01",
      end_year_month: null,
    },
    {
      amount_monthly: 50000,
      inflation_rate: 0,
      category: "education",
      start_year_month: "2025-07",
      end_year_month: "2026-06",
    },
  ],
  rentals: [
    {
      id: "rental-1",
      rent_monthly: 95000,
      start_year_month: "2024-01",
      end_year_month: null,
    },
  ],
  assets: [{ cash_balance: 850000, investment_balance: 3200000, return_rate: 0.035 }],
  mortgages: [
    {
      principal: 28000000,
      annual_rate: 0.012,
      years: 35,
      start_year_month: "2026-03",
      building_price: 23500000,
      land_price: 7250000,
      down_payment: 4000000,
    },
  ],
  lifeEvents: [
    {
      amount: 300000,
      year_month: "2025-08",
      repeat_interval_years: 1,
      stop_after_age: null,
      stop_after_occurrences: 2,
      category: "travel",
      auto_toggle_key: null,
      building_price: null,
      land_price: null,
      down_payment: null,
    },
    {
      amount: 2000000,
      year_month: "2026-03",
      repeat_interval_years: null,
      stop_after_age: null,
      stop_after_occurrences: null,
      category: "housing_purchase",
      auto_toggle_key: "HOUSING_PURCHASE_STOP_RENT",
      building_price: 23500000,
      land_price: 7250000,
      down_payment: 4000000,
    },
    {
      amount: 500000,
      year_month: "2026-12",
      repeat_interval_years: null,
      stop_after_age: null,
      stop_after_occurrences: null,
      category: "retirement_bonus",
      auto_toggle_key: null,
      building_price: null,
      land_price: null,
      down_payment: null,
    },
  ],
});

describe("simulation regression", () => {
  it("keeps results stable for multi-year scenarios with multiple events and fractional rates", () => {
    const result = simulateLifePlan(createRegressionInput());

    const serialized = {
      depletionYearMonth: result.depletionYearMonth,
      months: result.months.map((month) => ({
        yearMonth: month.yearMonth,
        age: month.age,
        spouseAge: month.spouseAge,
        totalIncome: month.totalIncome.toNumber(),
        totalExpense: month.totalExpense.toNumber(),
        eventAmount: month.eventAmount.toNumber(),
        cashBalance: month.cashBalance.toNumber(),
        investmentBalance: month.investmentBalance.toNumber(),
        totalBalance: month.totalBalance.toNumber(),
      })),
    };

    expect(serialized).toMatchInlineSnapshot(`
      {
        "depletionYearMonth": null,
        "months": [
          {
            "age": 34,
            "cashBalance": 861220,
            "eventAmount": 0,
            "investmentBalance": 3209333.3333333335,
            "spouseAge": 32,
            "totalBalance": 4070553.3333333335,
            "totalExpense": 308780,
            "totalIncome": 320000,
            "yearMonth": "2025-01",
          },
          {
            "age": 34,
            "cashBalance": 872440,
            "eventAmount": 0,
            "investmentBalance": 3218693.888888889,
            "spouseAge": 32,
            "totalBalance": 4091133.888888889,
            "totalExpense": 308780,
            "totalIncome": 320000,
            "yearMonth": "2025-02",
          },
          {
            "age": 34,
            "cashBalance": 883660,
            "eventAmount": 0,
            "investmentBalance": 3228081.7460648147,
            "spouseAge": 32,
            "totalBalance": 4111741.7460648147,
            "totalExpense": 308780,
            "totalIncome": 320000,
            "yearMonth": "2025-03",
          },
          {
            "age": 34,
            "cashBalance": 1074880,
            "eventAmount": 0,
            "investmentBalance": 3237496.984490837,
            "spouseAge": 32,
            "totalBalance": 4312376.984490837,
            "totalExpense": 308780,
            "totalIncome": 500000,
            "yearMonth": "2025-04",
          },
          {
            "age": 34,
            "cashBalance": 1266100,
            "eventAmount": 0,
            "investmentBalance": 3246939.684028935,
            "spouseAge": 32,
            "totalBalance": 4513039.684028935,
            "totalExpense": 308780,
            "totalIncome": 500000,
            "yearMonth": "2025-05",
          },
          {
            "age": 35,
            "cashBalance": 1857320,
            "eventAmount": 0,
            "investmentBalance": 3256409.9247740195,
            "spouseAge": 32,
            "totalBalance": 5113729.924774019,
            "totalExpense": 308780,
            "totalIncome": 900000,
            "yearMonth": "2025-06",
          },
          {
            "age": 35,
            "cashBalance": 2206540,
            "eventAmount": 0,
            "investmentBalance": 3265907.7870546104,
            "spouseAge": 32,
            "totalBalance": 5472447.78705461,
            "totalExpense": 358780,
            "totalIncome": 708000,
            "yearMonth": "2025-07",
          },
          {
            "age": 35,
            "cashBalance": 2655760,
            "eventAmount": 300000,
            "investmentBalance": 3275433.3514335197,
            "spouseAge": 32,
            "totalBalance": 5931193.351433519,
            "totalExpense": 358780,
            "totalIncome": 508000,
            "yearMonth": "2025-08",
          },
          {
            "age": 35,
            "cashBalance": 2804980,
            "eventAmount": 0,
            "investmentBalance": 3284986.6987085342,
            "spouseAge": 32,
            "totalBalance": 6089966.698708534,
            "totalExpense": 358780,
            "totalIncome": 508000,
            "yearMonth": "2025-09",
          },
          {
            "age": 35,
            "cashBalance": 2954200,
            "eventAmount": 0,
            "investmentBalance": 3294567.909913101,
            "spouseAge": 32,
            "totalBalance": 6248767.9099131,
            "totalExpense": 358780,
            "totalIncome": 508000,
            "yearMonth": "2025-10",
          },
          {
            "age": 35,
            "cashBalance": 3103420,
            "eventAmount": 0,
            "investmentBalance": 3304177.066317014,
            "spouseAge": 33,
            "totalBalance": 6407597.066317014,
            "totalExpense": 358780,
            "totalIncome": 508000,
            "yearMonth": "2025-11",
          },
          {
            "age": 35,
            "cashBalance": 3652640,
            "eventAmount": 0,
            "investmentBalance": 3313814.2494271053,
            "spouseAge": 33,
            "totalBalance": 6966454.249427105,
            "totalExpense": 358780,
            "totalIncome": 908000,
            "yearMonth": "2025-12",
          },
          {
            "age": 35,
            "cashBalance": 3798011.96,
            "eventAmount": 0,
            "investmentBalance": 3323479.5409879345,
            "spouseAge": 33,
            "totalBalance": 7121491.500987934,
            "totalExpense": 362628.04000000004,
            "totalIncome": 508000,
            "yearMonth": "2026-01",
          },
          {
            "age": 35,
            "cashBalance": 3943383.92,
            "eventAmount": 0,
            "investmentBalance": 3333173.022982483,
            "spouseAge": 33,
            "totalBalance": 7276556.942982483,
            "totalExpense": 362628.04000000004,
            "totalIncome": 508000,
            "yearMonth": "2026-02",
          },
          {
            "age": 35,
            "cashBalance": 6158283.88,
            "eventAmount": 2000000,
            "investmentBalance": 3342894.7776328484,
            "spouseAge": 33,
            "totalBalance": 9501178.657632848,
            "totalExpense": 293100.04000000004,
            "totalIncome": 508000,
            "yearMonth": "2026-03",
          },
          {
            "age": 35,
            "cashBalance": 6375883.84,
            "eventAmount": 0,
            "investmentBalance": 3352644.8874009443,
            "spouseAge": 33,
            "totalBalance": 9728528.727400944,
            "totalExpense": 293100.04000000004,
            "totalIncome": 510700,
            "yearMonth": "2026-04",
          },
          {
            "age": 35,
            "cashBalance": 6593483.8,
            "eventAmount": 0,
            "investmentBalance": 3362423.434989197,
            "spouseAge": 33,
            "totalBalance": 9955907.234989196,
            "totalExpense": 293100.04000000004,
            "totalIncome": 510700,
            "yearMonth": "2026-05",
          },
          {
            "age": 36,
            "cashBalance": 7261083.76,
            "eventAmount": 0,
            "investmentBalance": 3372230.503341249,
            "spouseAge": 33,
            "totalBalance": 10633314.263341248,
            "totalExpense": 293100.04000000004,
            "totalIncome": 960700,
            "yearMonth": "2026-06",
          },
          {
            "age": 36,
            "cashBalance": 7736883.72,
            "eventAmount": 0,
            "investmentBalance": 3382066.1756426613,
            "spouseAge": 33,
            "totalBalance": 11118949.89564266,
            "totalExpense": 243100.04,
            "totalIncome": 718900,
            "yearMonth": "2026-07",
          },
          {
            "age": 36,
            "cashBalance": 8312683.68,
            "eventAmount": 300000,
            "investmentBalance": 3391930.535321619,
            "spouseAge": 33,
            "totalBalance": 11704614.215321619,
            "totalExpense": 243100.04,
            "totalIncome": 518900,
            "yearMonth": "2026-08",
          },
          {
            "age": 36,
            "cashBalance": 8588483.64,
            "eventAmount": 0,
            "investmentBalance": 3401823.66604964,
            "spouseAge": 33,
            "totalBalance": 11990307.306049641,
            "totalExpense": 243100.04,
            "totalIncome": 518900,
            "yearMonth": "2026-09",
          },
          {
            "age": 36,
            "cashBalance": 8864283.600000001,
            "eventAmount": 0,
            "investmentBalance": 3411745.651742285,
            "spouseAge": 33,
            "totalBalance": 12276029.251742287,
            "totalExpense": 243100.04,
            "totalIncome": 518900,
            "yearMonth": "2026-10",
          },
          {
            "age": 36,
            "cashBalance": 9140083.560000002,
            "eventAmount": 0,
            "investmentBalance": 3421696.576559867,
            "spouseAge": 34,
            "totalBalance": 12561780.13655987,
            "totalExpense": 243100.04,
            "totalIncome": 518900,
            "yearMonth": "2026-11",
          },
          {
            "age": 36,
            "cashBalance": 10365883.520000003,
            "eventAmount": 0,
            "investmentBalance": 3431676.5249081664,
            "spouseAge": 34,
            "totalBalance": 13797560.04490817,
            "totalExpense": 243100.04,
            "totalIncome": 1468900,
            "yearMonth": "2026-12",
          },
          {
            "age": 36,
            "cashBalance": 10455066.175280003,
            "eventAmount": 0,
            "investmentBalance": 3441685.5814391486,
            "spouseAge": 34,
            "totalBalance": 13896751.756719152,
            "totalExpense": 247017.34472000002,
            "totalIncome": 336200,
            "yearMonth": "2027-01",
          },
          {
            "age": 36,
            "cashBalance": 10544248.830560002,
            "eventAmount": 0,
            "investmentBalance": 3451723.8310516793,
            "spouseAge": 34,
            "totalBalance": 13995972.661611682,
            "totalExpense": 247017.34472000002,
            "totalIncome": 336200,
            "yearMonth": "2027-02",
          },
          {
            "age": 36,
            "cashBalance": 10633431.485840002,
            "eventAmount": 0,
            "investmentBalance": 3461791.3588922466,
            "spouseAge": 34,
            "totalBalance": 14095222.84473225,
            "totalExpense": 247017.34472000002,
            "totalIncome": 336200,
            "yearMonth": "2027-03",
          },
          {
            "age": 36,
            "cashBalance": 10722614.141120002,
            "eventAmount": 0,
            "investmentBalance": 3471888.2503556823,
            "spouseAge": 34,
            "totalBalance": 14194502.391475685,
            "totalExpense": 247017.34472000002,
            "totalIncome": 336200,
            "yearMonth": "2027-04",
          },
          {
            "age": 36,
            "cashBalance": 10811796.796400001,
            "eventAmount": 0,
            "investmentBalance": 3482014.5910858866,
            "spouseAge": 34,
            "totalBalance": 14293811.387485888,
            "totalExpense": 247017.34472000002,
            "totalIncome": 336200,
            "yearMonth": "2027-05",
          },
          {
            "age": 37,
            "cashBalance": 11350979.45168,
            "eventAmount": 0,
            "investmentBalance": 3492170.4669765537,
            "spouseAge": 34,
            "totalBalance": 14843149.918656554,
            "totalExpense": 247017.34472000002,
            "totalIncome": 786200,
            "yearMonth": "2027-06",
          },
        ],
      }
    `);
  });
});
